#include <P18F2450.INC>

    global updatePhase, asm_init

NR_INPUTS equ D'3'
output  equ CCPR1L
inputs  equ PORTB

    udata
taboff res 1
cnt1    res 1
accu    res 1
phases  res 2*NR_INPUTS
was_carry res 1
FSR1_save_h   res 1
FSR1_save_l   res 1


    code

phases_incr_tab_hi
    addwf PCL,F,A
    dt  0x01,0x02,0x02

phases_incr_tab_lo
    addwf PCL,F,A
    dt  0x56,0x00,0xac
    return


sinetable1
    movwf taboff
    bcf STATUS,C
    rlcf taboff,F
    movlw HIGH(TABLE_START_sinetable)
    btfsc STATUS,C
    incf WREG,W
    movwf PCLATH
    movlw LOW(TABLE_START_sinetable)
    addwf taboff,W
    btfsc STATUS,C
    incf PCLATH,F
    movwf PCL
TABLE_START_sinetable
	dt	0x65,0x67,0x69,0x6c,0x6e,0x71,0x73,0x76
	dt	0x78,0x7a,0x7d,0x7f,0x82,0x84,0x86,0x88
	dt	0x8b,0x8d,0x8f,0x91,0x94,0x96,0x98,0x9a
	dt	0x9c,0x9e,0xa0,0xa2,0xa4,0xa6,0xa8,0xa9
	dt	0xab,0xad,0xaf,0xb0,0xb2,0xb3,0xb5,0xb6
	dt	0xb8,0xb9,0xba,0xbc,0xbd,0xbe,0xbf,0xc0
	dt	0xc1,0xc2,0xc3,0xc3,0xc4,0xc5,0xc6,0xc6
	dt	0xc7,0xc7,0xc7,0xc8,0xc8,0xc8,0xc8,0xc8
	dt	0xc9,0xc8,0xc8,0xc8,0xc8,0xc8,0xc7,0xc7
	dt	0xc7,0xc6,0xc6,0xc5,0xc4,0xc3,0xc3,0xc2
	dt	0xc1,0xc0,0xbf,0xbe,0xbd,0xbc,0xba,0xb9
	dt	0xb8,0xb6,0xb5,0xb3,0xb2,0xb0,0xaf,0xad
	dt	0xab,0xa9,0xa8,0xa6,0xa4,0xa2,0xa0,0x9e
	dt	0x9c,0x9a,0x98,0x96,0x94,0x91,0x8f,0x8d
	dt	0x8b,0x88,0x86,0x84,0x82,0x7f,0x7d,0x7a
	dt	0x78,0x76,0x73,0x71,0x6e,0x6c,0x69,0x67
	dt	0x65,0x62,0x60,0x5d,0x5b,0x58,0x56,0x53
	dt	0x51,0x4f,0x4c,0x4a,0x47,0x45,0x43,0x41
	dt	0x3e,0x3c,0x3a,0x38,0x35,0x33,0x31,0x2f
	dt	0x2d,0x2b,0x29,0x27,0x25,0x23,0x21,0x20
	dt	0x1e,0x1c,0x1a,0x19,0x17,0x16,0x14,0x13
	dt	0x11,0x10,0x0f,0x0d,0x0c,0x0b,0x0a,0x09
	dt	0x08,0x07,0x06,0x06,0x05,0x04,0x03,0x03
	dt	0x02,0x02,0x02,0x01,0x01,0x01,0x01,0x01
	dt	0x01,0x01,0x01,0x01,0x01,0x01,0x02,0x02
	dt	0x02,0x03,0x03,0x04,0x05,0x06,0x06,0x07
	dt	0x08,0x09,0x0a,0x0b,0x0c,0x0d,0x0f,0x10
	dt	0x11,0x13,0x14,0x16,0x17,0x19,0x1a,0x1c
	dt	0x1e,0x20,0x21,0x23,0x25,0x27,0x29,0x2b
	dt	0x2d,0x2f,0x31,0x33,0x35,0x38,0x3a,0x3c
	dt	0x3e,0x41,0x43,0x45,0x47,0x4a,0x4c,0x4f
	dt	0x51,0x53,0x56,0x58,0x5b,0x5d,0x60,0x62







updatePhase

    lfsr FSR0, phases
    clrf accu

    local i = 0
    while i < NR_INPUTS

    btfsc inputs, i ; if input is not active
    goto input_not_active#v(i)  ; goto done

    clrf was_carry

; input is active


    ; same with lo-byte
    movlw i
    call phases_incr_tab_lo
    addwf POSTINC0,F
    btfsc STATUS, C
    bsf was_carry, 1



    ; add hi-byte from phases_incr
    movlw i
    call phases_incr_tab_hi
    ; and add it to phases
    addwf INDF0,W
    btfsc was_carry, 1
    incf WREG,W
    movwf POSTINC0,A

    ; now high-byte of current phase is in W

;    movf cnt1,W

; workaround: cannot access 256byte table

    call sinetable1
    addwf accu,F              ; add it to accumulator

    goto final

input_not_active#v(i)

i = i + 1
    endw

final 
    movff accu,output
    return



asm_init
    clrf cnt1
    return


    end